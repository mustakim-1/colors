<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aura Palette Designer</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code&display=swap" rel="stylesheet">

<!--
/**************************************************************
*
*   STYLES - AURA EDITION
*
**************************************************************/
-->
    <style>
        :root {
            --bg-color: #1a1a1d;
            --card-bg-color: rgba(35, 37, 41, 0.7);
            --text-color: #f0f0f0;
            --text-muted: #a0a0a0;
            --primary-accent: #3b82f6; /* A slightly softer blue */
            --border-color: rgba(255, 255, 255, 0.1);
            --success-color: #22c55e;
            --fail-color: #ef4444;
            --font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            --font-family-mono: 'Fira Code', 'SF Mono', 'Menlo', 'Monaco', 'Courier New', monospace;
            --card-border-radius: 16px;
            --control-border-radius: 10px;
        }

        /* --- 1. Base & Layout --- */
        body {
            background-color: var(--bg-color);
            background-image: radial-gradient(circle at 50% 0%, rgba(59, 130, 246, 0.1), transparent 50%);
            color: var(--text-color);
            font-family: var(--font-family);
            margin: 0;
            padding: clamp(1.5rem, 5vw, 4rem);
            font-size: 16px;
            min-height: 100vh;
            box-sizing: border-box;
            background-attachment: fixed;
        }

        .container { width: 100%; max-width: 1500px; margin: 0 auto; }
        .page-header { text-align: center; margin-bottom: 2rem; }
        .page-header h1 {
            margin: 0; font-size: clamp(2.5rem, 6vw, 4rem); font-weight: 700;
            background: linear-gradient(90deg, #93c5fd, #3b82f6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: fadeInHeader 1s ease-out;
        }
        @keyframes fadeInHeader { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }

        .page-header p { margin-top: 0.5rem; color: var(--text-muted); font-size: 1.15rem; max-width: 650px; margin-left: auto; margin-right: auto; line-height: 1.6; animation: fadeInHeader 1s 0.2s ease-out backwards;}

        /* --- 2. New Tips Carousel --- */
        .tips-carousel-wrapper {
            margin-bottom: 3rem;
            position: relative;
        }
        .tips-carousel {
            background-color: rgba(59, 130, 246, 0.05);
            border: 1px solid var(--border-color);
            padding: 1.5rem 2rem;
            border-radius: var(--card-border-radius);
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .tips-track {
            display: flex;
            transition: transform 0.5s cubic-bezier(0.25, 1, 0.5, 1);
        }
        .tip-card {
            flex-shrink: 0;
            width: 100%;
            box-sizing: border-box;
            display: flex;
            align-items: center;
            gap: 1.5rem;
            color: var(--text-muted);
            padding: 0 1rem; /* Add some padding so content isn't flush with edges */
        }
        .tip-card svg {
            width: 48px;
            height: 48px;
            fill: var(--primary-accent);
            flex-shrink: 0;
        }
        .tip-card h3 { margin: 0 0 0.25rem 0; color: var(--text-color); font-size: 1.1rem; }
        .tip-card p { margin: 0; line-height: 1.5; }
        .tip-dots {
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 8px;
        }
        .tip-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.2);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .tip-dot.active {
            background-color: var(--primary-accent);
            transform: scale(1.2);
        }

        /* --- 3. Controls Panel (Glassmorphism) --- */
        .controls {
            background: var(--card-bg-color);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            padding: 1.5rem;
            border-radius: var(--card-border-radius);
            margin-bottom: 3rem;
            border: 1px solid var(--border-color);
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 1.5rem 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            position: sticky;
            top: 2rem;
            z-index: 10;
        }
        .control-group { display: flex; align-items: center; gap: 1rem; flex-grow: 1; min-width: 200px; }
        .control-group label { font-weight: 500; white-space: nowrap; color: var(--text-muted); }
        
        input[type="color"] { width: 44px; height: 44px; border-radius: 50%; cursor: pointer; border: 2px solid var(--border-color); -webkit-appearance: none; -moz-appearance: none; appearance: none; background-color: transparent; padding: 0; overflow: hidden; transition: transform 0.2s ease; }
        input[type="color"]:hover { transform: scale(1.1); }
        input[type="color"]::-webkit-color-swatch { border: none; border-radius: 50%; padding: 0; }
        input[type="color"]::-moz-color-swatch { border: none; border-radius: 50%; }

        .slider-group { flex-grow: 1; max-width: 180px; }
        .slider-group div { display: flex; justify-content: space-between; margin-bottom: 0.25rem; font-size: 0.9rem;}

        .toggle-buttons { display: flex; background-color: rgba(0,0,0,0.3); padding: 0.5rem; border-radius: var(--control-border-radius); }
        .toggle-buttons button { flex-grow: 1; background-color: transparent; color: var(--text-muted); border: none; padding: 0.6rem 0.5rem; border-radius: 6px; font-weight: 500; cursor: pointer; transition: all 0.2s ease; }
        .toggle-buttons button:hover { background-color: var(--border-color); color: var(--text-color); }
        .toggle-buttons button.active { background-color: var(--primary-accent); color: white; box-shadow: 0 0 10px rgba(59, 130, 246, 0.5); }
        
        button:active, input[type=range]:active { transform: scale(0.97); }

        .action-buttons { justify-content: flex-end; }
        .action-buttons button { background-color: rgba(255, 255, 255, 0.05); color: var(--text-muted); border: 1px solid var(--border-color); width: 44px; height: 44px; border-radius: var(--control-border-radius); cursor: pointer; transition: all 0.2s ease; display: flex; justify-content: center; align-items: center; }
        .action-buttons button:hover { background-color: var(--border-color); color: var(--text-color); }

        /* --- 4. Palette Grid & Cards --- */
        .palette-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 1.5rem; }
        .color-card {
            background-color: var(--card-bg-color); border-radius: var(--card-border-radius);
            overflow: hidden; display: flex; flex-direction: column;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            transition: transform 0.3s cubic-bezier(0.25, 1, 0.5, 1), box-shadow 0.3s ease;
            opacity: 0;
            animation: cardFadeIn 0.5s ease-out forwards;
        }
        @keyframes cardFadeIn { 
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .color-card:hover { transform: translateY(-10px); box-shadow: 0 12px 35px rgba(0,0,0,0.3); }
        
        .card__swatch {
            height: 150px; position: relative; cursor: pointer;
            border-bottom: 4px solid; /* Set in inline style */
        }
        .lock-btn { position: absolute; top: 12px; right: 12px; background: rgba(0,0,0,0.3); backdrop-filter: blur(5px); border: 1px solid rgba(255,255,255,0.1); border-radius: 50%; width: 36px; height: 36px; cursor: pointer; display: flex; justify-content: center; align-items: center; transition: all 0.2s ease; opacity: 0; transform: scale(0.8); }
        .color-card:hover .lock-btn { opacity: 1; transform: scale(1); }
        .lock-btn:hover { background: rgba(0,0,0,0.5); transform: scale(1.1); }
        .lock-btn svg { fill: white; opacity: 0.8; }
        .lock-btn.locked { opacity: 1; transform: scale(1); background: var(--primary-accent); }
        
        .card__info { padding: 1rem 1.25rem; display: flex; flex-direction: column; gap: 1rem; flex-grow: 1; }
        .color-codes-wrapper { display: flex; flex-direction: column; gap: 0.5rem; }
        .color-code { font-family: var(--font-family-mono); cursor: pointer; padding: 0.4rem 0.6rem; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; transition: background-color 0.2s; position: relative; }
        .color-code:hover { background-color: var(--border-color); }
        .color-code .type { color: var(--text-muted); font-weight: bold; }
        
        .primary-code { font-size: 1.1rem; font-weight: bold; border: 1px solid var(--primary-accent); background-color: rgba(59, 130, 246, 0.1); }
        .primary-code:hover { background-color: rgba(59, 130, 246, 0.2); }
        .primary-code .type { color: var(--primary-accent); }
        .secondary-code { font-size: 0.85rem; color: var(--text-muted); }
        .secondary-code .value { color: var(--text-color); }
        .color-code.copied { background-color: var(--success-color) !important; color: white; border-color: var(--success-color) !important; }
        .color-code.copied .type, .color-code.copied .value { color: white !important; }

        .card__accessibility { border-top: 1px solid var(--border-color); padding-top: 1rem; font-size: 0.85rem; display: flex; flex-direction: column; gap: 0.5rem; }
        .contrast-check { display: flex; justify-content: space-between; align-items: center; }
        .contrast-check .badge { font-weight: bold; padding: 3px 8px; border-radius: 12px; font-size: 0.75rem; }
        .contrast-check .pass { background-color: var(--success-color); color: white; }
        .contrast-check .fail { background-color: var(--fail-color); color: white; }
        .contrast-check-label { display: flex; align-items: center; gap: 0.3rem; }
        .help-icon { cursor: help; color: var(--text-muted); }

        /* --- 5. Modal & Utilities --- */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(8px); display: flex; justify-content: center; align-items: center; opacity: 0; visibility: hidden; transition: all 0.3s ease; z-index: 1000; }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal { background: var(--card-bg-color); padding: 2rem; border-radius: var(--card-border-radius); border: 1px solid var(--border-color); width: 90%; max-width: 600px; transform: scale(0.95) translateY(10px); transition: all 0.3s ease; box-shadow: 0 20px 50px rgba(0,0,0,0.4); }
        .modal-overlay.visible .modal { transform: scale(1) translateY(0); }
        .modal h2 { margin-top: 0; }
        .modal-tabs { display: flex; gap: 0.5rem; margin-bottom: 1rem; border-radius: var(--control-border-radius); background: rgba(0,0,0,0.3); padding: 0.5rem; }
        .modal-tabs button { flex-grow: 1; background: transparent; color: var(--text-muted); border: none; padding: 0.75rem; border-radius: 6px; cursor: pointer; transition: all 0.2s; font-weight: 500; }
        .modal-tabs button.active { background: var(--primary-accent); color: white; }
        #exportOutput { width: 100%; height: 200px; background: var(--bg-color); color: var(--text-color); border: 1px solid var(--border-color); border-radius: var(--control-border-radius); font-family: var(--font-family-mono); padding: 1rem; box-sizing: border-box; resize: vertical; }
        .modal-actions { margin-top: 1.5rem; display: flex; justify-content: space-between; align-items: center; }
        .modal-actions button { background: rgba(255,255,255,0.05); color: var(--text-muted); border: 1px solid var(--border-color); padding: 0.75rem 1.5rem; border-radius: var(--control-border-radius); cursor: pointer; transition: all 0.2s; }
        .modal-actions button#copyExportBtn { background-color: var(--primary-accent); color: white; border-color: var(--primary-accent); }
        .copy-feedback { color: var(--success-color); opacity: 0; transition: opacity 0.3s; font-weight: 500; }
        
        [data-tooltip] { position: relative; }
        [data-tooltip]::after {
            content: attr(data-tooltip); position: absolute; bottom: 125%; left: 50%; transform: translateX(-50%);
            background: #222; color: white; padding: 5px 10px; border-radius: 6px; font-size: 0.8rem;
            white-space: nowrap; opacity: 0; visibility: hidden; transition: opacity 0.2s 0.3s;
            pointer-events: none; z-index: 1001;
        }
        [data-tooltip]:hover::after { opacity: 1; visibility: visible; }
    </style>
</head>
<body>

<!--
/**************************************************************
*
*   HTML STRUCTURE
*
**************************************************************/
-->
    <div class="container">
        <header class="page-header">
            <h1>Aura Palette Designer</h1>
            <p>An elegant tool to generate, refine, and export production-ready color systems. Includes color locking, multi-format display, and WCAG accessibility checks.</p>
        </header>

        <section class="tips-carousel-wrapper">
            <div class="tips-carousel">
                <div class="tips-track">
                    <div class="tip-card" data-index="0">
                        <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
                        <div>
                            <h3>1. Pick a Base Color</h3>
                            <p>Use the color wheel to select your starting point or enter a HEX code.</p>
                        </div>
                    </div>
                    <div class="tip-card" data-index="1">
                         <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M14.06 9.02l.92.92L5.92 19H5v-.92l9.06-9.06M17.66 3c-.25 0-.51.1-.7.29l-1.83 1.83 3.75 3.75 1.83-1.83c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.2-.2-.45-.29-.71-.29zm-3.6 3.19L3 17.25V21h3.75L17.81 9.94l-3.75-3.75z"/></svg>
                        <div>
                            <h3>2. Choose a Harmony</h3>
                            <p>Select a color rule like Monochromatic or Analogous to generate a palette.</p>
                        </div>
                    </div>
                    <div class="tip-card" data-index="2">
                        <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px"><path d="M0 0h24v24H0z" fill="none"/><path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z"/></svg>
                        <div>
                            <h3>3. Adjust & Lock</h3>
                            <p>Tweak the palette size, then click the lock icon to fix any colors you love.</p>
                        </div>
                    </div>
                     <div class="tip-card" data-index="3">
                        <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
                        <div>
                            <h3>4. Copy & Export</h3>
                            <p>Click any color code to copy it, or use the export button for the full set.</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="tip-dots"></div>
        </section>

        <section class="controls">
            <div class="control-group">
                <label for="colorPicker" data-tooltip="This is the main color your palette is based on.">Base Color:</label>
                <input type="color" id="colorPicker">
                <div class="slider-group" data-tooltip="How many colors to generate (3 to 9).">
                    <div><label for="swatchCount">Palette Size:</label><span id="swatchCountLabel">5</span></div>
                    <input type="range" id="swatchCount" min="3" max="9" value="5">
                </div>
            </div>
            <div class="control-group">
                <label data-tooltip="Color harmony rules used to generate the palette.">Harmony:</label>
                <div class="toggle-buttons" id="ruleButtons">
                    <button data-mode="monochromatic" data-tooltip="Variations in lightness and saturation of a single color.">Mono</button>
                    <button data-mode="analogous" data-tooltip="Colors that are next to each other on the color wheel.">Analog</button>
                    <button data-mode="complementary" data-tooltip="Colors on opposite sides of the color wheel.">Comp</button>
                    <button data-mode="split-complementary" data-tooltip="A base color plus the two colors adjacent to its complement.">Split</button>
                    <button data-mode="triadic" data-tooltip="Three colors that are evenly spaced on the color wheel.">Triad</button>
                </div>
            </div>
            <div class="control-group">
                <label data-tooltip="The primary format displayed on top.">Format:</label>
                <div class="toggle-buttons" id="formatButtons">
                    <button data-format="hex">HEX</button>
                    <button data-format="rgb">RGB</button>
                    <button data-format="hsl">HSL</button>
                </div>
            </div>
            <div class="action-buttons control-group">
                <button id="randomBtn" data-tooltip="Generate a new random base color and palette"><svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24" fill="currentColor"><path d="M0 0h24v24H0z" fill="none"/><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-2.5 15.5c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm0-10c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm-7 10c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z"/></svg></button>
                <button id="exportBtn" data-tooltip="Export palette as code (CSS, SCSS, JSON)"><svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="currentColor"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg></button>
            </div>
        </section>

        <main class="palette-grid" id="paletteGrid"></main>
    </div>

    <div class="modal-overlay" id="exportModalOverlay">
        <div class="modal" id="exportModal">
            <h2>Export Palette</h2>
            <div class="modal-tabs" id="exportTabs">
                <button class="active" data-export-format="css">CSS Variables</button>
                <button data-export-format="scss">SCSS Variables</button>
                <button data-export-format="json">JSON Array</button>
            </div>
            <textarea id="exportOutput" readonly spellcheck="false"></textarea>
            <div class="modal-actions">
                <span class="copy-feedback" id="copyFeedback"></span>
                <div>
                    <button id="copyExportBtn">Copy to Clipboard</button>
                    <button id="closeModalBtn">Close</button>
                </div>
            </div>
        </div>
    </div>

<!--
/**************************************************************
*
*   JAVASCRIPT LOGIC - AURA EDITION
*
**************************************************************/
-->
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        
        // --- 1. STATE MANAGEMENT ---
        const state = {
            baseColor: '#3b82f6',
            mode: 'monochromatic',
            count: 5,
            displayFormat: 'hex',
            locked: Array(9).fill(null), 
            palette: []
        };

        const ui = {
            colorPicker: document.getElementById('colorPicker'),
            ruleButtons: document.getElementById('ruleButtons'),
            formatButtons: document.getElementById('formatButtons'),
            paletteGrid: document.getElementById('paletteGrid'),
            randomBtn: document.getElementById('randomBtn'),
            exportBtn: document.getElementById('exportBtn'),
            swatchCount: document.getElementById('swatchCount'),
            swatchCountLabel: document.getElementById('swatchCountLabel'),
            exportModalOverlay: document.getElementById('exportModalOverlay'),
            exportModal: document.getElementById('exportModal'),
            exportTabs: document.getElementById('exportTabs'),
            exportOutput: document.getElementById('exportOutput'),
            copyExportBtn: document.getElementById('copyExportBtn'),
            closeModalBtn: document.getElementById('closeModalBtn'),
            copyFeedback: document.getElementById('copyFeedback'),
            tipsCarousel: document.querySelector('.tips-carousel'),
            tipsTrack: document.querySelector('.tips-track'),
            tipCards: document.querySelectorAll('.tip-card'),
            tipDotsContainer: document.querySelector('.tip-dots'),
        };
        
        // --- 2. COLOR UTILITIES ---
        const Color = {
            hexToRgb: hex => { const r = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex); return r ? { r: parseInt(r[1], 16), g: parseInt(r[2], 16), b: parseInt(r[3], 16) } : null; },
            rgbToHex: ({r,g,b}) => "#"+((1<<24)+(r<<16)+(g<<8)+b).toString(16).slice(1).toUpperCase(),
            rgbToHsl: ({r,g,b}) => { 
                r/=255,g/=255,b/=255; let max=Math.max(r,g,b),min=Math.min(r,g,b); let h,s,l=(max+min)/2; 
                if(max==min){h=s=0}else{let d=max-min;s=l>0.5?d/(2-max-min):d/(max+min);switch(max){case r:h=(g-b)/d+(g<b?6:0);break;case g:h=(b-r)/d+2;break;case b:h=(r-g)/d+4} h/=6} 
                return {h:h*360,s:s*100,l:l*100}; 
            },
            hslToRgb: ({h,s,l}) => { 
                s/=100,l/=100; let c=(1-Math.abs(2*l-1))*s,x=c*(1-Math.abs((h/60)%2-1)),m=l-c/2,r=0,g=0,b=0; 
                if(0<=h&&h<60){r=c,g=x,b=0}else if(60<=h&&h<120){r=x,g=c,b=0}else if(120<=h&&h<180){r=0,g=c,b=x}else if(180<=h&&h<240){r=0,g=x,b=c}else if(240<=h&&h<300){r=x,g=0,b=c}else if(300<=h&&h<360){r=c,g=0,b=x} 
                return {r:Math.round((r+m)*255),g:Math.round((g+m)*255),b:Math.round((b+m)*255)}; 
            },
            getLuminance: ({r,g,b}) => [r,g,b].map(v=>{v/=255;return v<=0.03928?v/12.92:Math.pow((v+0.055)/1.055,2.4)}).reduce((acc, v, i) => acc + v * [0.2126, 0.7152, 0.0722][i], 0),
            getContrast: (rgb1, rgb2) => { const l1=Color.getLuminance(rgb1), l2=Color.getLuminance(rgb2); return (Math.max(l1,l2)+0.05)/(Math.min(l1,l2)+0.05); }
        };

        // --- 3. GENERATION LOGIC ---
        function generatePalette() {
            const baseHsl = Color.rgbToHsl(Color.hexToRgb(state.baseColor));
            let paletteHsl = [];
            const hueStep = 30; 

            for (let i = 0; i < state.count; i++) {
                if (state.locked[i]) {
                    paletteHsl.push(Color.rgbToHsl(Color.hexToRgb(state.locked[i])));
                    continue;
                }
                
                let newHsl;
                const centerIndex = Math.floor(state.count / 2);
                const p = i - centerIndex; 
                
                const L_MIN = 15;
                const L_MAX = 90;
                const L_RANGE = L_MAX - L_MIN;
                const normalizedL = L_MIN + (L_RANGE * i) / (state.count - 1);

                switch (state.mode) {
                    case 'monochromatic':
                        newHsl = { h: baseHsl.h, s: baseHsl.s, l: normalizedL };
                        break;
                    case 'analogous':
                        newHsl = { 
                            h: (baseHsl.h + p * hueStep + 360) % 360, 
                            s: baseHsl.s, 
                            l: Math.max(10, Math.min(95, baseHsl.l + p * 5))
                        };
                        break;
                    case 'complementary':
                         newHsl = {
                            h: (i % 2 === 0 ? baseHsl.h : (baseHsl.h + 180) % 360),
                            s: baseHsl.s,
                            l: normalizedL
                        };
                        break;
                    case 'split-complementary':
                        const baseComp = (baseHsl.h + 180) % 360;
                        let h = baseHsl.h;
                        if (state.count > 3 && i >= state.count - 2) {
                             h = (i === state.count - 2) 
                                ? (baseComp - hueStep + 360) % 360 
                                : (baseComp + hueStep + 360) % 360;
                        } else if (state.count === 3 && i > 0) {
                            h = (i === 1) 
                                ? (baseComp - hueStep + 360) % 360 
                                : (baseComp + hueStep + 360) % 360;
                        }
                        newHsl = { h: h, s: baseHsl.s, l: normalizedL };
                        break;
                    case 'triadic':
                        const triadic_h = (baseHsl.h + (i % 3) * 120) % 360;
                        newHsl = { h: triadic_h, s: baseHsl.s, l: normalizedL };
                        break;
                    default:
                        newHsl = { h: baseHsl.h, s: baseHsl.s, l: baseHsl.l };
                }
                
                newHsl.h = (newHsl.h + 360) % 360;
                newHsl.s = Math.max(0, Math.min(100, newHsl.s));
                newHsl.l = Math.max(5, Math.min(95, newHsl.l));
                paletteHsl.push(newHsl);
            }
            state.palette = paletteHsl.map(hsl => Color.rgbToHex(Color.hslToRgb(hsl)));
            state.locked = state.palette.map((color, i) => state.locked[i] ? color : null);
        }

        // --- 4. RENDER & UPDATE ---
        function render() {
            ui.colorPicker.value = state.baseColor;
            ui.swatchCount.value = state.count;
            ui.swatchCountLabel.textContent = state.count;
            ui.ruleButtons.querySelectorAll('button').forEach(b => b.classList.toggle('active', b.dataset.mode === state.mode));
            ui.formatButtons.querySelectorAll('button').forEach(b => b.classList.toggle('active', b.dataset.format === state.displayFormat));

            ui.paletteGrid.innerHTML = state.palette.map((hex, i) => {
                const rgb = Color.hexToRgb(hex);
                const hsl = Color.rgbToHsl(rgb);
                
                const formats = {
                    hex: { value: hex, display: hex },
                    rgb: { value: `rgb(${rgb.r}, ${rgb.g}, ${rgb.b})`, display: `${rgb.r}, ${rgb.g}, ${rgb.b}` },
                    hsl: { value: `hsl(${Math.round(hsl.h)}, ${Math.round(hsl.s)}%, ${Math.round(hsl.l)}%)`, display: `${Math.round(hsl.h)}Â°, ${Math.round(hsl.s)}%, ${Math.round(hsl.l)}%` },
                };
                
                const formatKeys = ['hex', 'rgb', 'hsl'].sort((a, b) => a === state.displayFormat ? -1 : (b === state.displayFormat ? 1 : 0));
                const codesHTML = formatKeys.map(format => `
                    <div class="color-code ${state.displayFormat === format ? 'primary-code' : 'secondary-code'}" data-value="${formats[format].value}" data-tooltip="Click to copy">
                        <span class="type">${format.toUpperCase()}</span>
                        <span class="value">${formats[format].display}</span>
                    </div>`).join('');
                
                const contrastWhite = Color.getContrast(rgb, {r:255,g:255,b:255}).toFixed(2);
                const contrastBlack = Color.getContrast(rgb, {r:0,g:0,b:0}).toFixed(2);
                const AA_RATIO = 4.5; 
                const passWhite = contrastWhite >= AA_RATIO; 
                const passBlack = contrastBlack >= AA_RATIO;
                const locked = !!state.locked[i];
                const accessibilityTooltip = "WCAG AA (Level 2) requires a contrast ratio of at least 4.5:1 for normal text.";
                const animationDelay = i * 70;

                return `
                <div class="color-card" style="animation-delay: ${animationDelay}ms;">
                    <div class="card__swatch" style="background-color: ${hex}; border-color: ${hex};" data-index="${i}">
                         <button class="lock-btn ${locked ? 'locked' : ''}" data-index="${i}" data-tooltip="${locked ? 'Unlock color' : 'Lock color'}">
                            <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="#FFFFFF">
                                ${locked 
                                    ? '<path d="M0 0h24v24H0z" fill="none"/><path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z"/>' 
                                    : '<path d="M0 0h24v24H0z" fill="none"/><path d="M12 17c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm6-9h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6h1.9c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2z"/>'
                                }
                            </svg>
                         </button>
                    </div>
                    <div class="card__info">
                        <div class="color-codes-wrapper">${codesHTML}</div>
                        <div class="card__accessibility">
                            <div class="contrast-check"><span class="contrast-check-label">vs White <span class="help-icon" data-tooltip="${accessibilityTooltip}">?</span></span><div>${contrastWhite} <span class="badge ${passWhite?'pass':'fail'}">${passWhite?'Pass':'Fail'}</span></div></div>
                            <div class="contrast-check"><span class="contrast-check-label">vs Black <span class="help-icon" data-tooltip="${accessibilityTooltip}">?</span></span><div>${contrastBlack} <span class="badge ${passBlack?'pass':'fail'}">${passBlack?'Pass':'Fail'}</span></div></div>
                        </div>
                    </div>
                </div>`;
            }).join('');
            updateURL();
        }

        function updateState(newState) {
            Object.assign(state, newState);
            if (newState.count !== undefined) {
                const newLocked = Array(9).fill(null);
                state.locked.slice(0, state.count).forEach((val, i) => newLocked[i] = val);
                state.locked = newLocked;
            }
            generatePalette();
            render();
        }

        // --- 5. URL PERSISTENCE ---
        function updateURL() {
            const lockedSimple = state.locked.slice(0, state.count).map(c => c ? c.substring(1) : '-');
            const hash = btoa(JSON.stringify({ c: state.baseColor.substring(1), m: state.mode, n: state.count, l: lockedSimple, d: state.displayFormat }));
            history.replaceState(null, '', '#' + hash);
        }

        function loadStateFromURL() {
            try {
                if (!window.location.hash || window.location.hash.length < 5) return false;
                const data = JSON.parse(atob(window.location.hash.substring(1)));
                const loadedState = {
                    baseColor: data.c ? `#${data.c}` : state.baseColor,
                    mode: data.m || state.mode,
                    count: data.n ? parseInt(data.n) : state.count,
                    displayFormat: data.d || state.displayFormat,
                };
                if (data.l) {
                    loadedState.locked = data.l.map(c => c === '-' ? null : `#${c}`);
                    while (loadedState.locked.length < 9) { loadedState.locked.push(null); }
                }
                updateState(loadedState);
                return true;
            } catch (e) { 
                console.warn("Could not load state from URL.", e); 
                return false;
            }
        }

        // --- 6. EVENT LISTENERS ---
        ui.colorPicker.addEventListener('input', e => updateState({ baseColor: e.target.value }));
        ui.swatchCount.addEventListener('input', e => updateState({ count: parseInt(e.target.value) }));
        ui.ruleButtons.addEventListener('click', e => e.target.tagName === 'BUTTON' && updateState({ mode: e.target.dataset.mode }));
        ui.formatButtons.addEventListener('click', e => e.target.tagName === 'BUTTON' && updateState({ displayFormat: e.target.dataset.format }));
        ui.randomBtn.addEventListener('click', () => {
            const randomColor = '#' + Math.floor(Math.random()*16777215).toString(16).padStart(6, '0');
            updateState({ baseColor: randomColor });
        });
        
        ui.paletteGrid.addEventListener('click', e => {
            const lockBtn = e.target.closest('.lock-btn');
            const colorCode = e.target.closest('.color-code');
            
            if (lockBtn) {
                const index = parseInt(lockBtn.dataset.index);
                state.locked[index] = state.locked[index] ? null : state.palette[index];
                updateState({});
            } else if (colorCode) {
                navigator.clipboard.writeText(colorCode.dataset.value).then(() => {
                    colorCode.classList.add('copied');
                    setTimeout(() => { colorCode.classList.remove('copied'); }, 1500);
                });
            }
        });
        
        // --- 7. EXPORT MODAL LOGIC ---
        function generateExportCode(format) {
            let output = '';
            const palette = state.palette;
            switch(format) {
                case 'css':
                    output = '/* CSS Variables */\n:root {\n';
                    palette.forEach((color, i) => { output += `  --color-primary-${i + 1}: ${color};\n`; });
                    output += '}';
                    break;
                case 'scss':
                    output = '// SCSS Variables\n';
                    palette.forEach((color, i) => { output += `$color-primary-${i + 1}: ${color};\n`; });
                    break;
                case 'json':
                     const jsonOutput = palette.map((hex, i) => {
                        const rgb = Color.hexToRgb(hex);
                        const hsl = Color.rgbToHsl(rgb);
                        return { name: `primary-${i + 1}`, hex: hex, rgb: `rgb(${rgb.r}, ${rgb.g}, ${rgb.b})`, hsl: `hsl(${Math.round(hsl.h)}, ${Math.round(hsl.s)}%, ${Math.round(hsl.l)}%)` };
                    });
                    output = JSON.stringify(jsonOutput, null, 2);
                    break;
            }
            ui.exportOutput.value = output;
        }

        function closeModal() { ui.exportModalOverlay.classList.remove('visible'); }
        ui.exportBtn.addEventListener('click', () => {
            const activeFormat = ui.exportTabs.querySelector('.active')?.dataset.exportFormat || 'css';
            generateExportCode(activeFormat);
            ui.exportModalOverlay.classList.add('visible');
        });
        ui.closeModalBtn.addEventListener('click', closeModal);
        ui.exportModalOverlay.addEventListener('click', (e) => e.target === ui.exportModalOverlay && closeModal());
        document.addEventListener('keydown', (e) => e.key === 'Escape' && ui.exportModalOverlay.classList.contains('visible') && closeModal());
        ui.exportTabs.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                ui.exportTabs.querySelector('.active')?.classList.remove('active');
                e.target.classList.add('active');
                generateExportCode(e.target.dataset.exportFormat);
            }
        });
        ui.copyExportBtn.addEventListener('click', () => {
            navigator.clipboard.writeText(ui.exportOutput.value).then(() => {
                ui.copyFeedback.textContent = 'Copied!';
                ui.copyFeedback.style.opacity = 1;
                setTimeout(() => { ui.copyFeedback.style.opacity = 0; }, 2000);
            });
        });
        
        // --- 8. TIPS CAROUSEL LOGIC ---
        let currentTip = 0;
        let tipInterval;
        const totalTips = ui.tipCards.length;

        function setupCarousel() {
            ui.tipDotsContainer.innerHTML = ''; // Clear dots before creating new ones
            for(let i=0; i < totalTips; i++){
                const dot = document.createElement('div');
                dot.classList.add('tip-dot');
                dot.dataset.index = i;
                if(i === 0) dot.classList.add('active');
                ui.tipDotsContainer.appendChild(dot);
            }
            startCarousel();
        }

        function showTip(index) {
            currentTip = index;
            // The percentage calculation is based on the container width, not the track width.
            const offset = -currentTip * 100;
            ui.tipsTrack.style.transform = `translateX(${offset}%)`;

            ui.tipDotsContainer.querySelectorAll('.tip-dot').forEach((dot, i) => {
                dot.classList.toggle('active', i === currentTip);
            });
        }
        
        function nextTip() {
            currentTip = (currentTip + 1) % totalTips;
            showTip(currentTip);
        }

        function startCarousel() {
            clearInterval(tipInterval);
            tipInterval = setInterval(nextTip, 5000); // Change slide every 5 seconds
        }

        ui.tipDotsContainer.addEventListener('click', (e) => {
            if(e.target.classList.contains('tip-dot')) {
                const index = parseInt(e.target.dataset.index);
                showTip(index);
                startCarousel(); // Reset interval on manual navigation
            }
        });
        
        ui.tipsCarousel.addEventListener('mouseenter', () => clearInterval(tipInterval));
        ui.tipsCarousel.addEventListener('mouseleave', startCarousel);


        // --- 9. INITIALIZATION ---
        setupCarousel();
        const loaded = loadStateFromURL();
        if(!loaded) {
             generatePalette();
             render();
        }
    });
    </script>
</body>
</html>